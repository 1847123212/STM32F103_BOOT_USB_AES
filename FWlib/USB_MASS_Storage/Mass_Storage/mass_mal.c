/*******************************************************************************
* File Name          : MAL 储存介质媒体访问层接口函数
* Author             : 叫我小陆吧
* Version            : V1.0
* Date               : 2015.09.9
* Description        : QQ:260869626
*******************************************************************************/

#include "platform_config.h"
#include "mass_mal.h"
#include "bsp.h"
#include <AES.h>

//把ram当做储存位置，ramdisk不需要很大，只要能放下FAT表头即可，ramdisk用途只是给电脑读取FAT表而已，不会存放app数据，预先设置好FAT表到ramdisk，连接电脑后直接识别成U盘，不再需要格式化
//把加密后的升级文件扔进电脑识别出的盘符内，底层通过升级文件内的特定标识来识别如果是正确的升级文件则写入flash，否则丢弃数据，错误的文件电脑上
//会显示写入成功，但是实际不会影响flash内原有的app程序，这样可以防止傻x真的拿这个当U盘用造成app程序损毁

#define RAMDISK_SIZE    32*1024  /* 放FAT表*/
#define SECTOR_SIZE     512     /* 一包数据大小，boot是以512位单位分包*/

static const u8 FAT_DBR_TABLE[]=
{ //FAT表的第0号扇区，有这个表就不用每次连接电脑都要格式化一遍，这个产生的方法是在电脑格式化成功后dump出整个ramdisk取前面512字节即可
0xEB,0x3C,0x90,0x4D,0x53,0x44,0x4F,0x53,0x35,0x2E,0x30,0x00,0x02,0x01,0x04,0x00,
0x02,0x00,0x02,0xF8,0x01,0xF8,0x02,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x00,0x29,0x9C,0xF8,0x5B,0x50,0x4E,0x4F,0x20,0x4E,0x41,
0x4D,0x45,0x20,0x20,0x20,0x20,0x46,0x41,0x54,0x31,0x32,0x20,0x20,0x20,0x33,0xC9,
0x8E,0xD1,0xBC,0xF0,0x7B,0x8E,0xD9,0xB8,0x00,0x20,0x8E,0xC0,0xFC,0xBD,0x00,0x7C,
0x38,0x4E,0x24,0x7D,0x24,0x8B,0xC1,0x99,0xE8,0x3C,0x01,0x72,0x1C,0x83,0xEB,0x3A,
0x66,0xA1,0x1C,0x7C,0x26,0x66,0x3B,0x07,0x26,0x8A,0x57,0xFC,0x75,0x06,0x80,0xCA,
0x02,0x88,0x56,0x02,0x80,0xC3,0x10,0x73,0xEB,0x33,0xC9,0x8A,0x46,0x10,0x98,0xF7,
0x66,0x16,0x03,0x46,0x1C,0x13,0x56,0x1E,0x03,0x46,0x0E,0x13,0xD1,0x8B,0x76,0x11,
0x60,0x89,0x46,0xFC,0x89,0x56,0xFE,0xB8,0x20,0x00,0xF7,0xE6,0x8B,0x5E,0x0B,0x03,
0xC3,0x48,0xF7,0xF3,0x01,0x46,0xFC,0x11,0x4E,0xFE,0x61,0xBF,0x00,0x00,0xE8,0xE6,
0x00,0x72,0x39,0x26,0x38,0x2D,0x74,0x17,0x60,0xB1,0x0B,0xBE,0xA1,0x7D,0xF3,0xA6,
0x61,0x74,0x32,0x4E,0x74,0x09,0x83,0xC7,0x20,0x3B,0xFB,0x72,0xE6,0xEB,0xDC,0xA0,
0xFB,0x7D,0xB4,0x7D,0x8B,0xF0,0xAC,0x98,0x40,0x74,0x0C,0x48,0x74,0x13,0xB4,0x0E,
0xBB,0x07,0x00,0xCD,0x10,0xEB,0xEF,0xA0,0xFD,0x7D,0xEB,0xE6,0xA0,0xFC,0x7D,0xEB,
0xE1,0xCD,0x16,0xCD,0x19,0x26,0x8B,0x55,0x1A,0x52,0xB0,0x01,0xBB,0x00,0x00,0xE8,
0x3B,0x00,0x72,0xE8,0x5B,0x8A,0x56,0x24,0xBE,0x0B,0x7C,0x8B,0xFC,0xC7,0x46,0xF0,
0x3D,0x7D,0xC7,0x46,0xF4,0x29,0x7D,0x8C,0xD9,0x89,0x4E,0xF2,0x89,0x4E,0xF6,0xC6,
0x06,0x96,0x7D,0xCB,0xEA,0x03,0x00,0x00,0x20,0x0F,0xB6,0xC8,0x66,0x8B,0x46,0xF8,
0x66,0x03,0x46,0x1C,0x66,0x8B,0xD0,0x66,0xC1,0xEA,0x10,0xEB,0x5E,0x0F,0xB6,0xC8,
0x4A,0x4A,0x8A,0x46,0x0D,0x32,0xE4,0xF7,0xE2,0x03,0x46,0xFC,0x13,0x56,0xFE,0xEB,
0x4A,0x52,0x50,0x06,0x53,0x6A,0x01,0x6A,0x10,0x91,0x8B,0x46,0x18,0x96,0x92,0x33,
0xD2,0xF7,0xF6,0x91,0xF7,0xF6,0x42,0x87,0xCA,0xF7,0x76,0x1A,0x8A,0xF2,0x8A,0xE8,
0xC0,0xCC,0x02,0x0A,0xCC,0xB8,0x01,0x02,0x80,0x7E,0x02,0x0E,0x75,0x04,0xB4,0x42,
0x8B,0xF4,0x8A,0x56,0x24,0xCD,0x13,0x61,0x61,0x72,0x0B,0x40,0x75,0x01,0x42,0x03,
0x5E,0x0B,0x49,0x75,0x06,0xF8,0xC3,0x41,0xBB,0x00,0x00,0x60,0x66,0x6A,0x00,0xEB,
0xB0,0x42,0x4F,0x4F,0x54,0x4D,0x47,0x52,0x20,0x20,0x20,0x20,0x0D,0x0A,0x52,0x65,
0x6D,0x6F,0x76,0x65,0x20,0x64,0x69,0x73,0x6B,0x73,0x20,0x6F,0x72,0x20,0x6F,0x74,
0x68,0x65,0x72,0x20,0x6D,0x65,0x64,0x69,0x61,0x2E,0xFF,0x0D,0x0A,0x44,0x69,0x73,
0x6B,0x20,0x65,0x72,0x72,0x6F,0x72,0xFF,0x0D,0x0A,0x50,0x72,0x65,0x73,0x73,0x20,
0x61,0x6E,0x79,0x20,0x6B,0x65,0x79,0x20,0x74,0x6F,0x20,0x72,0x65,0x73,0x74,0x61,
0x72,0x74,0x0D,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xAC,0xCB,0xD8,0x55,0xAA
//下面是两个FAT偏移，手动输入数据
//0x800 = F8 FF FF 03 40 00 05 F0 FF
//0xC00 = F8 FF FF 03 40 00 05 F0 FF
};
//这个是usb转串口的inf驱动的文件名和盘符信息
static const u8 FAT_FILE_NAME[]=
{//offect 0x1000
0x42,0x69,0x00,0x76,0x00,0x65,0x00,0x72,0x00,0x2E,0x00,0x0F,0x00,0x61,0x69,0x00,
0x6E,0x00,0x66,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,
0x01,0x59,0x00,0x61,0x00,0x6E,0x00,0x48,0x00,0x75,0x00,0x0F,0x00,0x61,0x61,0x00,
0x2D,0x00,0x43,0x00,0x4F,0x00,0x4D,0x00,0x2D,0x00,0x00,0x00,0x44,0x00,0x72,0x00,
0x59,0x41,0x4E,0x48,0x55,0x41,0x7E,0x31,0x49,0x4E,0x46,0x20,0x00,0xC6,0x63,0x8C,
0x29,0x47,0x29,0x47,0x00,0x00,0x2A,0x8C,0x29,0x47,0x02,0x00,0x49,0x07,0x00,0x00,
'B','O','O','T',' ','L','O','A','D','E','D',0x08,0x00,0x00,0x00,0x00,
//0x59,0x41,0x4E,0x48,0x55,0x41,0x20,0x4F,0x42,0x44,0x20,0x08,0x00,0x00,0x00,0x00,
// Y   A    N    H    U    A        O    B    D
0x00,0x00,0x00,0x00,0x00,0x00,0x6F,0x8C,0x29,0x47  
};
//这个是usb转串口的inf驱动文件内容，连接电脑识别U盘后可以直接复制出来，可以说自带驱动
static const u8 FAT_FILE_DATA[]=
{//offect 0x5000
0x3B,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x0D,
0x0A,0x3B,0x20,0x59,0x61,0x6E,0x68,0x75,0x61,0x20,0x43,0x6F,0x6D,0x75,0x6E,0x69,
0x63,0x61,0x74,0x69,0x6F,0x6E,0x20,0x44,0x65,0x76,0x69,0x63,0x65,0x20,0x43,0x6C,
0x61,0x73,0x73,0x20,0x64,0x72,0x69,0x76,0x65,0x72,0x20,0x28,0x43,0x44,0x43,0x29,
0x20,0x49,0x4E,0x46,0x20,0x46,0x49,0x4C,0x45,0x0D,0x0A,0x3B,0x20,0x28,0x43,0x29,
0x32,0x30,0x31,0x30,0x20,0x43,0x6F,0x70,0x79,0x72,0x69,0x67,0x68,0x74,0x20,0x59,
0x61,0x6E,0x48,0x75,0x61,0x2D,0x54,0x45,0x43,0x48,0x20,0x43,0x4F,0x2E,0x4C,0x74,
0x64,0x0D,0x0A,0x3B,0x20,0x4C,0x52,0x4D,0x20,0x32,0x30,0x31,0x35,0x2E,0x30,0x39,
0x2E,0x30,0x39,0x0D,0x0A,0x3B,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x0D,0x0A,0x0D,0x0A,0x5B,0x56,0x65,0x72,0x73,0x69,0x6F,0x6E,
0x5D,0x0D,0x0A,0x53,0x69,0x67,0x6E,0x61,0x74,0x75,0x72,0x65,0x3D,0x22,0x24,0x57,
0x69,0x6E,0x64,0x6F,0x77,0x73,0x20,0x4E,0x54,0x24,0x22,0x0D,0x0A,0x43,0x6C,0x61,
0x73,0x73,0x3D,0x50,0x6F,0x72,0x74,0x73,0x0D,0x0A,0x43,0x6C,0x61,0x73,0x73,0x47,
0x75,0x69,0x64,0x3D,0x7B,0x34,0x44,0x33,0x36,0x45,0x39,0x37,0x38,0x2D,0x45,0x33,
0x32,0x35,0x2D,0x31,0x31,0x43,0x45,0x2D,0x42,0x46,0x43,0x31,0x2D,0x30,0x38,0x30,
0x30,0x32,0x42,0x45,0x31,0x30,0x33,0x31,0x38,0x7D,0x0D,0x0A,0x50,0x72,0x6F,0x76,
0x69,0x64,0x65,0x72,0x3D,0x25,0x50,0x52,0x56,0x44,0x52,0x25,0x0D,0x0A,0x43,0x61,
0x74,0x61,0x6C,0x6F,0x67,0x46,0x69,0x6C,0x65,0x3D,0x73,0x74,0x6D,0x63,0x64,0x63,
0x2E,0x63,0x61,0x74,0x0D,0x0A,0x44,0x72,0x69,0x76,0x65,0x72,0x56,0x65,0x72,0x3D,
0x30,0x34,0x2F,0x32,0x35,0x2F,0x32,0x30,0x31,0x30,0x2C,0x31,0x2E,0x33,0x2E,0x31,
0x0D,0x0A,0x0D,0x0A,0x5B,0x53,0x6F,0x75,0x72,0x63,0x65,0x44,0x69,0x73,0x6B,0x73,
0x4E,0x61,0x6D,0x65,0x73,0x5D,0x0D,0x0A,0x31,0x3D,0x25,0x44,0x72,0x69,0x76,0x65,
0x72,0x73,0x44,0x69,0x73,0x6B,0x25,0x2C,0x2C,0x2C,0x0D,0x0A,0x0D,0x0A,0x5B,0x53,
0x6F,0x75,0x72,0x63,0x65,0x44,0x69,0x73,0x6B,0x73,0x46,0x69,0x6C,0x65,0x73,0x5D,
0x0D,0x0A,0x0D,0x0A,0x5B,0x4D,0x61,0x6E,0x75,0x66,0x61,0x63,0x74,0x75,0x72,0x65,
0x72,0x5D,0x0D,0x0A,0x25,0x4D,0x46,0x47,0x4E,0x41,0x4D,0x45,0x25,0x3D,0x44,0x65,
0x76,0x69,0x63,0x65,0x4C,0x69,0x73,0x74,0x2C,0x4E,0x54,0x2C,0x4E,0x54,0x61,0x6D,
0x64,0x36,0x34,0x0D,0x0A,0x0D,0x0A,0x5B,0x44,0x65,0x73,0x74,0x69,0x6E,0x61,0x74,
0x69,0x6F,0x6E,0x44,0x69,0x72,0x73,0x5D,0x0D,0x0A,0x44,0x65,0x66,0x61,0x75,0x6C,
0x74,0x44,0x65,0x73,0x74,0x44,0x69,0x72,0x20,0x3D,0x20,0x31,0x32,0x0D,0x0A,0x0D,
0x0A,0x3B,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x0D,0x0A,0x3B,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x56,
0x49,0x44,0x2F,0x50,0x49,0x44,0x20,0x53,0x65,0x74,0x74,0x69,0x6E,0x67,0x73,0x0D,
0x0A,0x3B,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x0D,0x0A,0x5B,0x44,0x65,0x76,0x69,0x63,0x65,0x4C,0x69,0x73,0x74,0x2E,0x4E,0x54,
0x5D,0x0D,0x0A,0x25,0x44,0x45,0x53,0x43,0x52,0x49,0x50,0x54,0x49,0x4F,0x4E,0x25,
0x3D,0x44,0x72,0x69,0x76,0x65,0x72,0x49,0x6E,0x73,0x74,0x61,0x6C,0x6C,0x2C,0x55,
0x53,0x42,0x5C,0x56,0x49,0x44,0x5F,0x30,0x34,0x38,0x33,0x26,0x50,0x49,0x44,0x5F,
0x35,0x37,0x34,0x30,0x0D,0x0A,0x0D,0x0A,0x5B,0x44,0x65,0x76,0x69,0x63,0x65,0x4C,
0x69,0x73,0x74,0x2E,0x4E,0x54,0x61,0x6D,0x64,0x36,0x34,0x5D,0x0D,0x0A,0x25,0x44,
0x45,0x53,0x43,0x52,0x49,0x50,0x54,0x49,0x4F,0x4E,0x25,0x3D,0x44,0x72,0x69,0x76,
0x65,0x72,0x49,0x6E,0x73,0x74,0x61,0x6C,0x6C,0x2C,0x55,0x53,0x42,0x5C,0x56,0x49,
0x44,0x5F,0x30,0x34,0x38,0x33,0x26,0x50,0x49,0x44,0x5F,0x35,0x37,0x34,0x30,0x0D,
0x0A,0x0D,0x0A,0x5B,0x44,0x72,0x69,0x76,0x65,0x72,0x49,0x6E,0x73,0x74,0x61,0x6C,
0x6C,0x2E,0x4E,0x54,0x5D,0x0D,0x0A,0x49,0x6E,0x63,0x6C,0x75,0x64,0x65,0x3D,0x6D,
0x64,0x6D,0x63,0x70,0x71,0x2E,0x69,0x6E,0x66,0x0D,0x0A,0x43,0x6F,0x70,0x79,0x46,
0x69,0x6C,0x65,0x73,0x3D,0x46,0x61,0x6B,0x65,0x4D,0x6F,0x64,0x65,0x6D,0x43,0x6F,
0x70,0x79,0x46,0x69,0x6C,0x65,0x53,0x65,0x63,0x74,0x69,0x6F,0x6E,0x0D,0x0A,0x41,
0x64,0x64,0x52,0x65,0x67,0x3D,0x44,0x72,0x69,0x76,0x65,0x72,0x49,0x6E,0x73,0x74,
0x61,0x6C,0x6C,0x2E,0x4E,0x54,0x2E,0x41,0x64,0x64,0x52,0x65,0x67,0x0D,0x0A,0x0D,
0x0A,0x5B,0x44,0x72,0x69,0x76,0x65,0x72,0x49,0x6E,0x73,0x74,0x61,0x6C,0x6C,0x2E,
0x4E,0x54,0x2E,0x41,0x64,0x64,0x52,0x65,0x67,0x5D,0x0D,0x0A,0x48,0x4B,0x52,0x2C,
0x2C,0x44,0x65,0x76,0x4C,0x6F,0x61,0x64,0x65,0x72,0x2C,0x2C,0x2A,0x6E,0x74,0x6B,
0x65,0x72,0x6E,0x0D,0x0A,0x48,0x4B,0x52,0x2C,0x2C,0x4E,0x54,0x4D,0x50,0x44,0x72,
0x69,0x76,0x65,0x72,0x2C,0x2C,0x75,0x73,0x62,0x73,0x65,0x72,0x2E,0x73,0x79,0x73,
0x0D,0x0A,0x48,0x4B,0x52,0x2C,0x2C,0x45,0x6E,0x75,0x6D,0x50,0x72,0x6F,0x70,0x50,
0x61,0x67,0x65,0x73,0x33,0x32,0x2C,0x2C,0x22,0x4D,0x73,0x50,0x6F,0x72,0x74,0x73,
0x2E,0x64,0x6C,0x6C,0x2C,0x53,0x65,0x72,0x69,0x61,0x6C,0x50,0x6F,0x72,0x74,0x50,
0x72,0x6F,0x70,0x50,0x61,0x67,0x65,0x50,0x72,0x6F,0x76,0x69,0x64,0x65,0x72,0x22,
0x0D,0x0A,0x0D,0x0A,0x5B,0x44,0x72,0x69,0x76,0x65,0x72,0x49,0x6E,0x73,0x74,0x61,
0x6C,0x6C,0x2E,0x4E,0x54,0x2E,0x53,0x65,0x72,0x76,0x69,0x63,0x65,0x73,0x5D,0x0D,
0x0A,0x41,0x64,0x64,0x53,0x65,0x72,0x76,0x69,0x63,0x65,0x3D,0x75,0x73,0x62,0x73,
0x65,0x72,0x2C,0x20,0x30,0x78,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x32,0x2C,0x20,
0x44,0x72,0x69,0x76,0x65,0x72,0x53,0x65,0x72,0x76,0x69,0x63,0x65,0x49,0x6E,0x73,
0x74,0x0D,0x0A,0x0D,0x0A,0x5B,0x44,0x72,0x69,0x76,0x65,0x72,0x53,0x65,0x72,0x76,
0x69,0x63,0x65,0x49,0x6E,0x73,0x74,0x5D,0x0D,0x0A,0x44,0x69,0x73,0x70,0x6C,0x61,
0x79,0x4E,0x61,0x6D,0x65,0x3D,0x25,0x53,0x45,0x52,0x56,0x49,0x43,0x45,0x25,0x0D,
0x0A,0x53,0x65,0x72,0x76,0x69,0x63,0x65,0x54,0x79,0x70,0x65,0x20,0x3D,0x20,0x31,
0x20,0x3B,0x20,0x53,0x45,0x52,0x56,0x49,0x43,0x45,0x5F,0x4B,0x45,0x52,0x4E,0x45,
0x4C,0x5F,0x44,0x52,0x49,0x56,0x45,0x52,0x0D,0x0A,0x53,0x74,0x61,0x72,0x74,0x54,
0x79,0x70,0x65,0x20,0x3D,0x20,0x33,0x20,0x3B,0x20,0x53,0x45,0x52,0x56,0x49,0x43,
0x45,0x5F,0x44,0x45,0x4D,0x41,0x4E,0x44,0x5F,0x53,0x54,0x41,0x52,0x54,0x0D,0x0A,
0x45,0x72,0x72,0x6F,0x72,0x43,0x6F,0x6E,0x74,0x72,0x6F,0x6C,0x20,0x3D,0x20,0x31,
0x20,0x3B,0x20,0x53,0x45,0x52,0x56,0x49,0x43,0x45,0x5F,0x45,0x52,0x52,0x4F,0x52,
0x5F,0x4E,0x4F,0x52,0x4D,0x41,0x4C,0x0D,0x0A,0x53,0x65,0x72,0x76,0x69,0x63,0x65,
0x42,0x69,0x6E,0x61,0x72,0x79,0x3D,0x20,0x25,0x31,0x32,0x25,0x5C,0x75,0x73,0x62,
0x73,0x65,0x72,0x2E,0x73,0x79,0x73,0x0D,0x0A,0x4C,0x6F,0x61,0x64,0x4F,0x72,0x64,
0x65,0x72,0x47,0x72,0x6F,0x75,0x70,0x20,0x3D,0x20,0x42,0x61,0x73,0x65,0x0D,0x0A,
0x0D,0x0A,0x3B,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x0D,0x0A,0x3B,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x53,0x74,0x72,0x69,0x6E,0x67,0x20,0x44,0x65,0x66,0x69,0x6E,0x69,0x74,
0x69,0x6F,0x6E,0x73,0x0D,0x0A,0x3B,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,0x2D,
0x2D,0x2D,0x2D,0x2D,0x2D,0x0D,0x0A,0x0D,0x0A,0x5B,0x53,0x74,0x72,0x69,0x6E,0x67,
0x73,0x5D,0x0D,0x0A,0x50,0x52,0x56,0x44,0x52,0x20,0x3D,0x20,0x22,0x59,0x61,0x6E,
0x48,0x75,0x61,0x20,0x54,0x65,0x63,0x68,0x22,0x0D,0x0A,0x4D,0x46,0x47,0x4E,0x41,
0x4D,0x45,0x20,0x3D,0x20,0x22,0x59,0x61,0x6E,0x48,0x75,0x61,0x20,0x54,0x65,0x63,
0x68,0x2E,0x22,0x0D,0x0A,0x44,0x45,0x53,0x43,0x52,0x49,0x50,0x54,0x49,0x4F,0x4E,
0x20,0x3D,0x20,0x22,0x59,0x48,0x2D,0x54,0x45,0x43,0x48,0x20,0x56,0x69,0x72,0x74,
0x75,0x61,0x6C,0x20,0x43,0x4F,0x4D,0x20,0x50,0x6F,0x72,0x74,0x22,0x0D,0x0A,0x53,
0x45,0x52,0x56,0x49,0x43,0x45,0x20,0x3D,0x20,0x22,0x59,0x48,0x2D,0x54,0x45,0x43,
0x48,0x20,0x56,0x43,0x4F,0x4D,0x22,0x0D,0x0A,0x44,0x72,0x69,0x76,0x65,0x72,0x73,
0x44,0x69,0x73,0x6B,0x20,0x3D,0x20,0x22,0x59,0x48,0x20,0x44,0x72,0x69,0x76,0x65,
0x72,0x73,0x20,0x44,0x69,0x73,0x6B,0x22,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00 
};

union 	                                        /* 将4个u8字符合并成一个u32 */
{
   u8  char_4[4];
   u32 long_1;	
} char2long;

u8 RAM_DISK[RAMDISK_SIZE];//定义一个缓冲，格式化和收发数据都在这里进行

u32 Mass_Memory_Size;
u32 Mass_Block_Size;
u32 Mass_Block_Count;

/*******************************************************************************
* File Name          : 
* Author             : 叫我小陆吧
* Version            : V1.0
* Date               : 2015.09.9
* Description        : 初始化ramdis，建立FAT表让电脑识别U盘
*
*                      欺骗电脑，让电脑显示252k大小，否则会提示空间不足,boot占用24k，stm32f103rc总大小256k
*                      app可用256-24=232k，让电脑虚拟出252kU盘，格式化后正好是可用232k不多不少正好等于app最大长度   
*******************************************************************************/
 u16 MAL_Init(u8 lun)
 {
   u16 i=0;
   
   Mass_Block_Count = 252*1024/SECTOR_SIZE;
   Mass_Block_Size =  SECTOR_SIZE;
   Mass_Memory_Size = 252*1024;
   
   for(i=0;i<sizeof(FAT_DBR_TABLE);i++)//重建FAT表
   {
     RAM_DISK[i]=FAT_DBR_TABLE[i];
   }
   #if 0
   for(i=0;i<sizeof(FAT_FILE_NAME);i++)
   {
     RAM_DISK[i+0x1000]=FAT_FILE_NAME[i];
   }
   
   for(i=0;i<sizeof(FAT_FILE_DATA);i++)
   {
     RAM_DISK[i+0x5000]=FAT_FILE_DATA[i];
   }  
   #endif
   RAM_DISK[0x800]=0xF8;
   RAM_DISK[0x801]=0xFF;
   RAM_DISK[0x802]=0xFF;
   RAM_DISK[0x803]=0x03;
   RAM_DISK[0x804]=0x40;
   RAM_DISK[0x805]=0x00;
   RAM_DISK[0x806]=0x05;
   RAM_DISK[0x807]=0xF0;
   RAM_DISK[0x808]=0xFF;
   
   RAM_DISK[0xC00]=0xF8;
   RAM_DISK[0xC01]=0xFF;
   RAM_DISK[0xC02]=0xFF;
   RAM_DISK[0xC03]=0x03;
   RAM_DISK[0xC04]=0x40;
   RAM_DISK[0xC05]=0x00;
   RAM_DISK[0xC06]=0x05;
   RAM_DISK[0xC07]=0xF0;
   RAM_DISK[0xC08]=0xFF;   
   
   return lun == 0 ? MAL_OK : MAL_FAIL;
 }
 
/*******************************************************************************
* File Name          : 
* Author             : 叫我小陆吧
* Version            : V1.0
* Date               : 2015.09.9
* Description        : 电脑发来的数据其实不必真的写入ramdisk，选取自己想要的数据即可
*******************************************************************************/
 u16 MAL_Write(u8 lun, u32 Memory_Offset, u32 *Writebuff, u16 Transfer_Length)
 {
    u32 i,j,k;
    u8 *p=(u8*)Writebuff;
    static u8 is_update_file=0;
    static u32 write_cnt=0;

    
    if(lun == 0)
    {
      //检查是否有”AAAABBBBCCCCDDDDEEEE“标记，有的话说明是正确的升级文件，第一包512字节数据， 只包含识别信息，不包含程序，程序从第2包开始
      if(Writebuff[0]==0x41414141 && Writebuff[1]==0x42424242 && Writebuff[2]==0x43434343 && Writebuff[3]==0x44444444 && Writebuff[4]==0x45454545)
      {
      
        is_update_file=1;               //开始写入flash
        write_cnt=0; 
        FLASH_Unlock();   
        
        for(i=IN_FLASH_STAR; i<IN_FLASH_END;i+=IN_FLASH_SECTOR)//擦除app区域
        {
          if(FLASH_WaitForLastOperation(FLASH_WAIT_TIMEOUT)!=FLASH_TIMEOUT)
          {
            FLASH_ClearFlag(FLASH_FLAG_EOP|FLASH_FLAG_PGERR|FLASH_FLAG_WRPRTERR);
          }
          FLASH_ErasePage(i);
        }        
        return MAL_OK;   
      }
      else if(is_update_file==1)                        //第1包开始是有效升级数据
      {
         for(i=0;i<SECTOR_SIZE;i++)
           FLASH_TMP_BUF[i]=p[i];
         
         AES_DECODE(KEY,FLASH_TMP_BUF,SECTOR_SIZE);     //解密
         
         for( i=0;i<SECTOR_SIZE/4;i++)                  //写入
         {
            if(FLASH_WaitForLastOperation(FLASH_WAIT_TIMEOUT)!=FLASH_TIMEOUT)
            {
              FLASH_ClearFlag(FLASH_FLAG_EOP|FLASH_FLAG_PGERR|FLASH_FLAG_WRPRTERR);
            }
            char2long.char_4[3] =  FLASH_TMP_BUF[i*4+3];
            char2long.char_4[2] =  FLASH_TMP_BUF[i*4+2];
            char2long.char_4[1] =  FLASH_TMP_BUF[i*4+1];
            char2long.char_4[0] =  FLASH_TMP_BUF[i*4];
            FLASH_ProgramWord(IN_FLASH_STAR + write_cnt , char2long.long_1);
            write_cnt += 4;
         }      
        return MAL_OK;  
     }
     
    //其实不需要真的写入ramdisk,注释掉写入ramdisk的话就可以阻止格式化操作，然并卵，让你格又怎样，反正不会丢数据
      if(Memory_Offset<RAMDISK_SIZE)
      {
         for( i=0;i<Transfer_Length;i+=4)
         {
            *(u32*)(&RAM_DISK[Memory_Offset+i])=Writebuff[i>>2];
         }
      }                            
      return MAL_OK;     
      
    }
    return MAL_FAIL;
 }

/*******************************************************************************
* File Name          : 
* Author             : 叫我小陆吧
* Version            : V1.0
* Date               : 2015.09.9
* Description        : 读取出的数据只是FAT表，不会有真正的app程序被读出
*******************************************************************************/
 u16 MAL_Read(u8 lun, u32 Memory_Offset, u32 *Readbuff, u16 Transfer_Length)
 {
    u16 i;
  
    if(lun == 0)
    {
      
      if(Memory_Offset<RAMDISK_SIZE)//防止溢出，这里读出的是ramdisk的内容，不会包含app程序
      {      
         for( i=0;i<Transfer_Length;i+=4)
         {
           Readbuff[i>>2] = *(u32*)(&RAM_DISK[Memory_Offset+i]);
         }
      }
     
     return MAL_OK;
    }
   return MAL_FAIL;
 }
 
/*******************************************************************************
* File Name          : 
* Author             : 叫我小陆吧
* Version            : V1.0
* Date               : 2015.09.9
* Description        : 
*******************************************************************************/
 u16 MAL_GetStatus (u8 lun)
 {
   
   if(lun == 0)
   {        
     return MAL_OK;
   }

   return MAL_FAIL;
 }
